<Project ToolsVersion="15.0" TreatAsLocalProperty="_TestPackagesDirectory" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <_TestPackagesDirectory>$(TargetDir)packages</_TestPackagesDirectory>
  </PropertyGroup>

  <Target Name="PackProjectsUnderTest" AfterTargets="Build">
    <MSBuild BuildInParallel="true" Projects="@(BuildProjectUnderTest)" Targets="Pack;_GetOutputItemsFromPack">
      <Output TaskParameter="TargetOutputs" ItemName="_BuildProjectPackOutputs" />
    </MSBuild>

    <ItemGroup>
      <_BuildProjectPackages Include="@(_BuildProjectPackOutputs)" Condition="'%(Extension)' == '.nupkg'" />
    </ItemGroup>

    <Error Code="BLP4010" Text="%24(_TestPackagesDirectory) is empty." Condition="'$(_TestPackagesDirectory)' == ''" />
    <RemoveDir Directories="$(_TestPackagesDirectory)" />
    <MakeDir Directories="$(_TestPackagesDirectory)" />
    <Copy SourceFiles="@(_BuildProjectPackages)" DestinationFolder="$(_TestPackagesDirectory)" />
  </Target>



  <!-- Output Configuration -->
  <ItemGroup>
    <None Update="samples/**/*" CopyToOutputDirectory="PreserveNewest" />
    <None Include="samples/**/*.*proj" CopyToOutputDirectory="PreserveNewest" />
    <_DiscardedSamples Include="$(TargetDir)/samples/**/*" />
    <_CurrentSamples Include="samples/**/*" />
    <_DiscardedSamples Remove="@(_CurrentSamples->'$(TargetDir)%(Identity)')" />
    <_CurrentSamples Remove="@(_CurrentSamples)" />
  </ItemGroup>

  <Target Name="RemoveOldSampleFiles" BeforeTargets="Build">
    <Delete Files="@(_DiscardedSamples)" />
  </Target>



  <PropertyGroup>
    <DefineConstants Condition="'$(BelpTestUseMSBuildModuleInitializer)' != 'false'">$(DefineConstants);BELP_BUILD_TEST_MSBUILD_MODULE_INITIALIZER</DefineConstants>
  </PropertyGroup>

</Project>
